import streamlit as st
import pandas as pd
import openai  # 구버전 라이브러리 사용

# 1. 페이지 기본 설정
st.set_page_config(page_title="Jewelry Info App", page_icon="💎", layout="wide")

# =========================================================
# [설정] API 키 입력 (구버전 0.28 방식)
# =========================================================
# 👇 아래 따옴표("") 안에 본인의 실제 API Key(sk-...)를 붙여넣으세요!
openai.api_key = st.secrets["API_KEY"]

# ==========================================
# [데이터] 명품/일반 80개 데이터 로드
# ==========================================
@st.cache_data 
def load_data():
    data = [
        # [명품]
        {"상품명": "까르띠에 러브 링", "종류": "반지", "구분": "명품", "판매량": 25000, "가격": 2800000},
        {"상품명": "불가리 비제로원 3밴드", "종류": "반지", "구분": "명품", "판매량": 18000, "가격": 3800000},
        {"상품명": "샤넬 코코 크러쉬 미니", "종류": "반지", "구분": "명품", "판매량": 16500, "가격": 2400000},
        {"상품명": "티파니 앤 코 T1 링", "종류": "반지", "구분": "명품", "판매량": 14000, "가격": 2100000},
        {"상품명": "부쉐론 콰트로 클래식", "종류": "반지", "구분": "명품", "판매량": 12000, "가격": 6800000},
        {"상품명": "쇼메 비 마이 러브", "종류": "반지", "구분": "명품", "판매량": 11500, "가격": 2100000},
        {"상품명": "구찌 아이콘 링", "종류": "반지", "구분": "명품", "판매량": 9800, "가격": 1200000},
        {"상품명": "피아제 포제션 오픈 링", "종류": "반지", "구분": "명품", "판매량": 8500, "가격": 3400000},
        {"상품명": "디올 젬 디올 링", "종류": "반지", "구분": "명품", "판매량": 7200, "가격": 3100000},
        {"상품명": "해리윈스턴 마이크로파베", "종류": "반지", "구분": "명품", "판매량": 900, "가격": 45000000},
        {"상품명": "반클리프 빈티지 알함브라", "종류": "목걸이", "구분": "명품", "판매량": 22000, "가격": 4200000},
        {"상품명": "티파니 앤 코 스마일 펜던트", "종류": "목걸이", "구분": "명품", "판매량": 19000, "가격": 1750000},
        {"상품명": "다미아니 벨 에포크", "종류": "목걸이", "구분": "명품", "판매량": 13000, "가격": 8900000},
        {"상품명": "불가리 디바스 드림", "종류": "목걸이", "구분": "명품", "판매량": 11000, "가격": 3500000},
        {"상품명": "쇼파드 해피 하트", "종류": "목걸이", "구분": "명품", "판매량": 9500, "가격": 4800000},
        {"상품명": "까르띠에 클래쉬 드 까르띠에", "종류": "목걸이", "구분": "명품", "판매량": 8800, "가격": 5200000},
        {"상품명": "디올 로즈 드 방", "종류": "목걸이", "구분": "명품", "판매량": 7600, "가격": 2800000},
        {"상품명": "드비어스 인챈티드 로터스", "종류": "목걸이", "구분": "명품", "판매량": 5400, "가격": 6200000},
        {"상품명": "루이비통 이디얼 블라썸", "종류": "목걸이", "구분": "명품", "판매량": 6100, "가격": 3500000},
        {"상품명": "그라프 버터플라이 실루엣", "종류": "목걸이", "구분": "명품", "판매량": 2100, "가격": 12000000},
        {"상품명": "에르메스 클릭 H", "종류": "팔찌", "구분": "명품", "판매량": 28000, "가격": 1150000},
        {"상품명": "까르띠에 저스트 앵 끌루", "종류": "팔찌", "구분": "명품", "판매량": 14500, "가격": 11000000},
        {"상품명": "반클리프 스위트 알함브라", "종류": "팔찌", "구분": "명품", "판매량": 13000, "가격": 2100000},
        {"상품명": "티파니 하드웨어 링크", "종류": "팔찌", "구분": "명품", "판매량": 10500, "가격": 3800000},
        {"상품명": "프레드 포스텐 브레이슬릿", "종류": "팔찌", "구분": "명품", "판매량": 9200, "가격": 4500000},
        {"상품명": "메시카 무브 클래식", "종류": "팔찌", "구분": "명품", "판매량": 6500, "가격": 4100000},
        {"상품명": "부쉐론 쎄뻥 보헴", "종류": "팔찌", "구분": "명품", "판매량": 5800, "가격": 8200000},
        {"상품명": "루이비통 볼트 업사이드", "종류": "팔찌", "구분": "명품", "판매량": 4200, "가격": 11500000},
        {"상품명": "샤넬 코코 크러쉬 뱅글", "종류": "팔찌", "구분": "명품", "판매량": 7800, "가격": 12000000},
        {"상품명": "불가리 세르펜티 바이퍼", "종류": "팔찌", "구분": "명품", "판매량": 4900, "가격": 9800000},
        {"상품명": "샤넬 CC 로고 이어링", "종류": "귀걸이", "구분": "명품", "판매량": 32000, "가격": 980000},
        {"상품명": "반클리프 빈티지 알함브라 이어링", "종류": "귀걸이", "구분": "명품", "판매량": 15000, "가격": 5600000},
        {"상품명": "디올 트라이벌 귀걸이", "종류": "귀걸이", "구분": "명품", "판매량": 21000, "가격": 890000},
        {"상품명": "까르띠에 트리니티 이어링", "종류": "귀걸이", "구분": "명품", "판매량": 11000, "가격": 3900000},
        {"상품명": "티파니 앤 코 오픈하트 스터드", "종류": "귀걸이", "구분": "명품", "판매량": 14000, "가격": 1200000},
        {"상품명": "불가리 디바스 드림 이어링", "종류": "귀걸이", "구분": "명품", "판매량": 8900, "가격": 4100000},
        {"상품명": "부쉐론 콰트로 후프", "종류": "귀걸이", "구분": "명품", "판매량": 6500, "가격": 9200000},
        {"상품명": "쇼메 주 드 리앙", "종류": "귀걸이", "구분": "명품", "판매량": 7200, "가격": 2300000},
        {"상품명": "피아제 로즈 이어링", "종류": "귀걸이", "구분": "명품", "판매량": 4300, "가격": 5800000},
        {"상품명": "그라프 파베 버터플라이", "종류": "귀걸이", "구분": "명품", "판매량": 1200, "가격": 18000000},

        # [일반]
        {"상품명": "판도라 노티드 하트", "종류": "반지", "구분": "일반", "판매량": 85000, "가격": 78000},
        {"상품명": "제이에스티나 마리벨", "종류": "반지", "구분": "일반", "판매량": 52000, "가격": 130000},
        {"상품명": "스와로브스키 비토레 링", "종류": "반지", "구분": "일반", "판매량": 48000, "가격": 115000},
        {"상품명": "스톤헨지 실버 링", "종류": "반지", "구분": "일반", "판매량": 45000, "가격": 88000},
        {"상품명": "로이드 10k 데일리 링", "종류": "반지", "구분": "일반", "판매량": 61000, "가격": 59000},
        {"상품명": "에나소루나 펄 링", "종류": "반지", "구분": "일반", "판매량": 12000, "가격": 250000},
        {"상품명": "아가타 베이직 링", "종류": "반지", "구분": "일반", "판매량": 28000, "가격": 68000},
        {"상품명": "엠주 씬 링", "종류": "반지", "구분": "일반", "판매량": 24000, "가격": 45000},
        {"상품명": "디디에두보 센슈얼 링", "종류": "반지", "구분": "일반", "판매량": 18000, "가격": 298000},
        {"상품명": "OST 탄생석 반지", "종류": "반지", "구분": "일반", "판매량": 95000, "가격": 29900},
        {"상품명": "스와로브스키 스완 목걸이", "종류": "목걸이", "구분": "일반", "판매량": 92000, "가격": 185000},
        {"상품명": "스톤헨지 댄싱스톤", "종류": "목걸이", "구분": "일반", "판매량": 75000, "가격": 380000},
        {"상품명": "비비안웨스트우드 진주", "종류": "목걸이", "구분": "일반", "판매량": 68000, "가격": 280000},
        {"상품명": "제이에스티나 조엘", "종류": "목걸이", "구분": "일반", "판매량": 54000, "가격": 140000},
        {"상품명": "디디에두보 드봉 디디", "종류": "목걸이", "구분": "일반", "판매량": 32000, "가격": 458000},
        {"상품명": "타사키 밸런스 네오", "종류": "목걸이", "구분": "일반", "판매량": 8500, "가격": 3500000},
        {"상품명": "아가타 스코티 펜던트", "종류": "목걸이", "구분": "일반", "판매량": 42000, "가격": 118000},
        {"상품명": "코치 시그니처 네크리스", "종류": "목걸이", "구분": "일반", "판매량": 21000, "가격": 150000},
        {"상품명": "티르리르 튤립 목걸이", "종류": "목걸이", "구분": "일반", "판매량": 36000, "가격": 65000},
        {"상품명": "마이클코어스 로고 하트", "종류": "목걸이", "구분": "일반", "판매량": 19000, "가격": 130000},
        {"상품명": "판도라 모멘츠 팔찌", "종류": "팔찌", "구분": "일반", "판매량": 110000, "가격": 128000},
        {"상품명": "스와로브스키 에밀리 테니스", "종류": "팔찌", "구분": "일반", "판매량": 56000, "가격": 240000},
        {"상품명": "스톤헨지 스텔라 브레이슬릿", "종류": "팔찌", "구분": "일반", "판매량": 42000, "가격": 168000},
        {"상품명": "비비안웨스트우드 미니 바", "종류": "팔찌", "구분": "일반", "판매량": 38000, "가격": 230000},
        {"상품명": "로이드 데일리 체인", "종류": "팔찌", "구분": "일반", "판매량": 59000, "가격": 89000},
        {"상품명": "모니카 비나더 피지", "종류": "팔찌", "구분": "일반", "판매량": 14000, "가격": 380000},
        {"상품명": "OST 메쉬 시계형 팔찌", "종류": "팔찌", "구분": "일반", "판매량": 72000, "가격": 39900},
        {"상품명": "디디에두보 미스 두", "종류": "팔찌", "구분": "일반", "판매량": 11000, "가격": 358000},
        {"상품명": "메트로시티 튜보라레", "종류": "팔찌", "구분": "일반", "판매량": 25000, "가격": 95000},
        {"상품명": "폴스미스 가죽 팔찌", "종류": "팔찌", "구분": "일반", "판매량": 18000, "가격": 150000},
        {"상품명": "제이에스티나 티아라", "종류": "귀걸이", "구분": "일반", "판매량": 58000, "가격": 120000},
        {"상품명": "APM 모나코 메테오라이트", "종류": "귀걸이", "구분": "일반", "판매량": 25000, "가격": 180000},
        {"상품명": "스톤헨지 실버 귀걸이", "종류": "귀걸이", "구분": "일반", "판매량": 47000, "가격": 98000},
        {"상품명": "앨린 파이프 링", "종류": "귀걸이", "구분": "일반", "판매량": 33000, "가격": 42000},
        {"상품명": "케이트스페이드 스터드", "종류": "귀걸이", "구분": "일반", "판매량": 29000, "가격": 89000},
        {"상품명": "모니카 비나더 사이렌", "종류": "귀걸이", "구분": "일반", "판매량": 15000, "가격": 210000},
        {"상품명": "골든듀 18k 귀걸이", "종류": "귀걸이", "구분": "일반", "판매량": 11000, "가격": 450000},
        {"상품명": "미니골드 14k 링", "종류": "귀걸이", "구분": "일반", "판매량": 42000, "가격": 79000},
        {"상품명": "토마스사보 이어 스터드", "종류": "귀걸이", "구분": "일반", "판매량": 13000, "가격": 90000},
        {"상품명": "Mzuu 펄 드롭", "종류": "귀걸이", "구분": "일반", "판매량": 21000, "가격": 55000},
    ]
    return pd.DataFrame(data)

df = load_data()

# ==========================================
# [메인 제목] "which one"
# ==========================================
st.markdown('<h1>🤔 <span style="color: #8B4513;">which</span> one</h1>', unsafe_allow_html=True)
st.caption("글로벌 인기 주얼리 데이터 & AI 큐레이터")

# ==========================================
# [탭 구성]
# ==========================================
tab1, tab2, tab3 = st.tabs(["✨ 명품관 (Luxury)", "💍 일반관 (Daily)", "🤖 AI 큐레이터"])

def show_ranking(category_name):
    st.subheader(f"🏆 {category_name} 베스트셀러")
    filtered_df = df[df['구분'] == category_name]
    
    search_query = st.text_input(f"{category_name} 검색", key=category_name, placeholder="반지, 목걸이, 브랜드명...")
    
    if search_query:
        filtered_df = filtered_df[
            filtered_df['종류'].str.contains(search_query) | 
            filtered_df['상품명'].str.contains(search_query)
        ]
    
    sorted_df = filtered_df.sort_values(by='판매량', ascending=False).reset_index(drop=True)
    sorted_df.index = sorted_df.index + 1
    
    display_df = sorted_df.copy()
    display_df['가격'] = display_df['가격'].apply(lambda x: f"{x:,}원")
    
    st.dataframe(display_df[['상품명', '종류', '판매량', '가격']], use_container_width=True, height=(len(display_df)+1)*35+3)

with tab1:
    show_ranking("명품")
with tab2:
    show_ranking("일반")

# ==========================================
# [탭 3] AI 큐레이터 (구버전 호환 코드)
# ==========================================
with tab3:
    st.subheader("💬 무엇이든 물어보세요")
    st.markdown("AI가 당신의 질문에 대해 풍부한 지식과 데이터를 바탕으로 답변해 드립니다.")
    
    user_query = st.text_input("질문 입력", placeholder="예: 300만원대 명품 반지 추천해줘, 티파니의 역사는?")
    
    if user_query:
        with st.spinner("AI가 지식을 탐색 중입니다... 🧠"):
            try:
                data_context = df.to_string()
                
                # 👇 여기가 중요! 구버전(0.28) 방식 사용
                response = openai.ChatCompletion.create(
                    model="gpt-3.5-turbo",
                    messages=[
                        {
                            "role": "system", 
                            "content": f"""
                            당신은 주얼리 전문 큐레이터입니다.
                            1. 질문에 대해 당신의 풍부한 외부 지식(역사, 트렌드 등)을 총동원해 설명하세요.
                            2. 아래 [데이터]는 현재 매장 재고입니다. 추천 시에는 이 데이터를 우선 참고하세요.
                            
                            [데이터]
                            {data_context}
                            """
                        },
                        {"role": "user", "content": user_query}
                    ]
                )
                
                # 👇 구버전 답변 추출 방식
                st.success("AI 큐레이터의 답변")
                st.markdown(response['choices'][0]['message']['content'])
                
            except Exception as e:
                st.error(f"오류 발생: {e}")
                st.info("키가 잘못되었거나 일시적 오류일 수 있습니다.")
