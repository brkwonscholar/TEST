import os
import json
import random
import urllib.parse
from typing import Optional

import streamlit as st
from openai import OpenAI
import requests

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0. í™˜ê²½ì„¤ì • (API í‚¤)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API_KEY = st.secrets["API_KEY"]  # .streamlit/secrets.toml ì— API_KEY ì„¤ì •
os.environ["OPENAI_API_KEY"] = st.secrets['API_KEY']

client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. OpenAI í˜¸ì¶œ (ì±… ì¶”ì²œìš©)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def ai_generate(prompt: str, max_tokens: int = 900) -> str:
    """í…ìŠ¤íŠ¸(ì±… ì¶”ì²œ)ë¥¼ ìœ„í•œ OpenAI Chat Completions í˜¸ì¶œ"""
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": (
                    "ë„ˆëŠ” í•œêµ­ ë…ìë¥¼ ìœ„í•œ ì±… ì¶”ì²œ ì „ë¬¸ê°€ì•¼. "
                    "ì‚¬ìš©ìì˜ ê°ì • ìƒíƒœë¥¼ ì§„ì§€í•˜ê²Œ ë°˜ì˜í•´ì„œ ì±…ì„ ê³ ë¥´ê³ , "
                    "ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” í•œêµ­ì–´(ì›ì„œ/ë²ˆì—­) ì±…ë§Œ ì¶”ì²œí•´ì•¼ í•´. "
                    "ì¶œíŒì‚¬, ì €ì, ë‚´ìš©ì„ ìµœëŒ€í•œ ì •í™•íˆ ì“°ë ¤ê³  ë…¸ë ¥í•´."
                ),
            },
            {"role": "user", "content": prompt},
        ],
        max_tokens=max_tokens,
    )
    return response.choices[0].message.content.strip()


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Google Booksì—ì„œ í‘œì§€/í‰ì  ê°€ì ¸ì˜¤ê¸° (ê°œì„  ë²„ì „, 3.9 í˜¸í™˜)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def get_book_metadata(title: str, author: str = "") -> dict:
    """
    Google Booksì—ì„œ í‘œì§€ + í‰ì  ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
    - ì—¬ëŸ¬ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ì‹œë„
    - í•œ ë²ˆì— ì—¬ëŸ¬ ê¶Œ(maxResults=5)ì„ ë°›ì•„ì„œ, í‘œì§€ ìˆëŠ” ì±…ì„ ìš°ì„  ì„ íƒ
    """

    def _search(query: str, lang: Optional[str] = None) -> dict:
        url = "https://www.googleapis.com/books/v1/volumes"
        params = {
            "q": query,
            "maxResults": 5,  # ì—¬ëŸ¬ ê¶Œ ë°›ì•„ë³´ê¸°
            "printType": "books",
        }
        if lang:
            params["langRestrict"] = lang

        try:
            resp = requests.get(url, params=params, timeout=5)
        except Exception:
            return {}

        if resp.status_code != 200:
            return {}

        data = resp.json()
        items = data.get("items", [])
        if not items:
            return {}

        # 1ìˆœìœ„: í‘œì§€ê°€ ìˆëŠ” ì±…
        best_with_cover = None
        first_item = items[0]

        for item in items:
            info = item.get("volumeInfo", {})
            image_links = info.get("imageLinks", {})
            cover_url = image_links.get("thumbnail") or image_links.get("smallThumbnail")
            if cover_url:
                best_with_cover = item
                break

        target = best_with_cover or first_item
        info = target.get("volumeInfo", {})
        image_links = info.get("imageLinks", {})

        cover_url = image_links.get("thumbnail") or image_links.get("smallThumbnail")
        average_rating = info.get("averageRating")
        ratings_count = info.get("ratingsCount")

        return {
            "cover_url": cover_url,
            "average_rating": average_rating,
            "ratings_count": ratings_count,
        }

    # â”€â”€ ê²€ìƒ‰ ì¿¼ë¦¬ êµ¬ì„± â”€â”€
    queries = []
    main_author = ""
    if author and author != "ì €ì ì •ë³´ ì—†ìŒ":
        main_author = author.split(",")[0].strip()

    if main_author:
        queries.extend(
            [
                'intitle:"{}" inauthor:"{}"'.format(title, main_author),
                '"{}" {}'.format(title, main_author),
            ]
        )

    # ì œëª© ìœ„ì£¼ ì¿¼ë¦¬
    queries.extend(
        [
            'intitle:"{}"'.format(title),
            '"{}"'.format(title),
            title,
        ]
    )

    # 1ì°¨: í•œêµ­ì–´ ìš°ì„ 
    for q in queries:
        meta = _search(q, lang="ko")
        if meta:
            return meta

    # 2ì°¨: ì–¸ì–´ ì œí•œ ì—†ì´
    for q in queries:
        meta = _search(q, lang=None)
        if meta:
            return meta

    # ê·¸ë˜ë„ ì—†ìœ¼ë©´ ë¹ˆ dict
    return {}


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. êµë³´ë¬¸ê³  ì œëª© ê²€ìƒ‰ ë§í¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_kyobo_url(title: str) -> str:
    encoded = urllib.parse.quote_plus(title)
    return "https://search.kyobobook.co.kr/search?keyword={}".format(encoded)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ê°ì • ì˜µì…˜ (ì´ëª¨í‹°ì½˜ + ì„¸ë¶€ ê°ì • + ê°ì •ë³„ ìŠ¤íƒ€ì¼)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EMOTION_MAIN = [
    "ğŸ˜Š ê¸°ì¨/ì„¤ë ˜",
    "ğŸ˜¢ ìŠ¬í””",
    "ğŸ˜° ë¶ˆì•ˆ/ê±±ì •",
    "ğŸ˜ ë¬´ê¸°ë ¥/ì§€ì¹¨",
    "ğŸ˜¡ í™”ë‚¨/ì§œì¦",
    "ğŸ˜¤ ìŠ¤íŠ¸ë ˆìŠ¤/ì••ë°•",
    "ğŸ˜” ì™¸ë¡œì›€",
    "ğŸ¤” ìš°ìš¸ê°",
    "ğŸ˜Œ í‰ì˜¨/ë‚˜ë¦„ ê´œì°®ìŒ",
]

EMOTION_DETAIL_MAP = {
    "ğŸ˜Š ê¸°ì¨/ì„¤ë ˜": [
        "ê·¸ëƒ¥ ê¸°ë¶„ì´ ì¢‹ì•„ìš”",
        "ì„¤ë ˆëŠ” ì¼ì´ ìˆì—ˆì–´ìš”",
        "ë¿Œë“¯í•˜ê³  ë³´ëŒì°¬ ê¸°ë¶„ì´ì—ìš”",
        "ëˆ„êµ°ê°€ì—ê²Œ ê³ ë§ˆìš´ ë§ˆìŒì´ì—ìš”",
    ],
    "ğŸ˜¢ ìŠ¬í””": [
        "ì´ìœ  ì—†ì´ ëˆˆë¬¼ì´ ë‚˜ìš”",
        "ì´ë³„/ìƒì‹¤ ë•Œë¬¸ì— ìŠ¬í¼ìš”",
        "ë‚´ê°€ ì´ˆë¼í•˜ê²Œ ëŠê»´ì ¸ìš”",
        "í˜„ì‹¤ì´ ë²„ê±°ì›Œì„œ ìŠ¬í¼ìš”",
    ],
    "ğŸ˜° ë¶ˆì•ˆ/ê±±ì •": [
        "ì•ë‚ ì´ ë§‰ë§‰í•´ìš”",
        "ì‹œí—˜/í•™ì—… ë•Œë¬¸ì— ë¶ˆì•ˆí•´ìš”",
        "ê´€ê³„ê°€ ë¶ˆì•ˆí•´ìš”",
        "ê´œíˆ ë§ˆìŒì´ ì¡°ë§ˆì¡°ë§ˆí•´ìš”",
    ],
    "ğŸ˜ ë¬´ê¸°ë ¥/ì§€ì¹¨": [
        "ì•„ë¬´ê²ƒë„ í•˜ê¸° ì‹«ì–´ìš”",
        "ëª¸ë„ ë§ˆìŒë„ ì§€ì³¤ì–´ìš”",
        "ì˜ìš•ì´ 1ë„ ì—†ì–´ìš”",
        "í•´ì•¼ í•  ê±¸ ì•„ëŠ”ë°ë„ ëª» í•˜ê² ì–´ìš”",
    ],
    "ğŸ˜¡ í™”ë‚¨/ì§œì¦": [
        "ì‚¬ì†Œí•œ ê²ƒë„ ë‹¤ ì§œì¦ë‚˜ìš”",
        "ëˆ„êµ°ê°€ì—ê²Œ í™”ê°€ ë§ì´ ë‚˜ ìˆì–´ìš”",
        "ë‚˜ ìì‹ ì—ê²Œ í™”ê°€ ë‚˜ìš”",
        "ì–µìš¸í•œ ì¼ì´ ìˆì–´ì„œ ë¶„í•´ìš”",
    ],
    "ğŸ˜¤ ìŠ¤íŠ¸ë ˆìŠ¤/ì••ë°•": [
        "í•™ì—…/ì‹œí—˜ ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ìš”",
        "ëˆ/ì•Œë°”/ìƒí™œë¹„ ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ìš”",
        "ì§„ë¡œ/ì·¨ì—… ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ìš”",
        "ì§ì¥/ì„±ê³¼/ì—…ë¬´ ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ìš”",
        "ì¸ê°„ê´€ê³„ ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ìš”",
        "ê°€ì¡±/ì§‘ì•ˆì¼ ë•Œë¬¸ì— ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•„ìš”",
    ],
    "ğŸ˜” ì™¸ë¡œì›€": [
        "ëŒ€í™”í•  ì‚¬ëŒì´ ì—†ì–´ìš”",
        "ê´œíˆ ì†Œì™¸ëœ ëŠë‚Œì´ì—ìš”",
        "ì‚¬ëŒë“¤ ì†ì—ì„œë„ ì™¸ë¡œì›Œìš”",
        "ëˆ„êµ°ê°€ê°€ ê·¸ë¦¬ì›Œìš”",
    ],
    "ğŸ¤” ìš°ìš¸ê°": [
        "ë§ˆìŒì´ ì „ì²´ì ìœ¼ë¡œ ê°€ë¼ì•‰ì•„ ìˆì–´ìš”",
        "ì•„ë¬´ë„ ë‚˜ë¥¼ ëª¨ë¥´ëŠ” ê²ƒ ê°™ì•„ìš”",
        "ë‚´ê°€ ì“¸ëª¨ì—†ëŠ” ì‚¬ëŒì²˜ëŸ¼ ëŠê»´ì ¸ìš”",
        "í•˜ë£¨í•˜ë£¨ ë²„í‹°ëŠ” ëŠë‚Œì´ì—ìš”",
    ],
    "ğŸ˜Œ í‰ì˜¨/ë‚˜ë¦„ ê´œì°®ìŒ": [
        "ì¡°ìš©íˆ ì‰¬ê³  ì‹¶ì€ ë‚ ì´ì—ìš”",
        "ë§ˆìŒì´ ëŒ€ì²´ë¡œ í¸ì•ˆí•´ìš”",
        "ìƒê° ì •ë¦¬ë¥¼ í•˜ê³  ì‹¶ì–´ìš”",
        "ì°¨ë¶„í•˜ê²Œ ë‚˜ë¥¼ ëŒì•„ë³´ê³  ì‹¶ì–´ìš”",
    ],
}

# ê°ì •ë³„ë¡œ ì–´ë–¤ í†¤ì˜ ì±…ì„ ê³¨ë¼ì•¼ í•˜ëŠ”ì§€ íŒíŠ¸
EMOTION_STYLE = {
    "ğŸ˜Š ê¸°ì¨/ì„¤ë ˜": (
        "ì „ì²´ì ìœ¼ë¡œ ë°ê³  ê°€ë³ê±°ë‚˜, ì„¤ë ˜ê³¼ í–‰ë³µê°ì„ ì˜¤ë˜ ì´ì–´ê°ˆ ìˆ˜ ìˆëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "í¬ë§ì ì´ê³  ì—ë„ˆì§€ ë„˜ì¹˜ê±°ë‚˜, ë”°ëœ»í•˜ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ë¶„ìœ„ê¸°ì˜ ì±…ì„ ìš°ì„ ì ìœ¼ë¡œ ê³¨ë¼ë¼. "
        "ì§€ë‚˜ì¹˜ê²Œ ë¬´ê²ê³  ìš°ìš¸í•œ ë¶„ìœ„ê¸°ì˜ ì±…ì€ í”¼í•˜ëŠ” í¸ì´ ì¢‹ë‹¤."
    ),
    "ğŸ˜¢ ìŠ¬í””": (
        "ì§€ê¸ˆì˜ ìŠ¬í””ì„ ìˆëŠ” ê·¸ëŒ€ë¡œ ì´í•´í•´ ì£¼ê³ , ì¡°ìš©íˆ ìœ„ë¡œí•´ ì¤„ ìˆ˜ ìˆëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ëˆˆë¬¼ì„ í˜ë¦¬ë©´ì„œë„ ë§ˆìŒì´ ì¡°ê¸ˆì”© í’€ì–´ì§€ëŠ” ì´ì•¼ê¸°, ìƒì‹¤ê³¼ íšŒë³µì„ ë‹¤ë£¨ëŠ” ì±…, "
        "í˜¹ì€ ë‹¤ì •í•œ ë¬¸ì¥ìœ¼ë¡œ ê³ì„ ì§€ì¼œì£¼ëŠ” ì—ì„¸ì´ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ê³¨ë¼ë¼."
    ),
    "ğŸ˜° ë¶ˆì•ˆ/ê±±ì •": (
        "ë§‰ë§‰í•¨ê³¼ ë¶ˆì•ˆì„ ì§„ì •ì‹œí‚¤ê³ , ìƒê°ì„ ì°¨ë¶„í•˜ê²Œ ì •ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ ì£¼ëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ë¶ˆì•ˆì— ëŒ€í•œ ì‹¬ë¦¬í•™, ì‚¶ì˜ ì†ë„ë¥¼ ì¡°ì ˆí•˜ê²Œ ë„ì™€ì£¼ëŠ” ì—ì„¸ì´, "
        "í˜„ì‹¤ ë„í”¼ìš©ìœ¼ë¡œ ì™„ì „íˆ ëª°ì…í•  ìˆ˜ ìˆëŠ” ì†Œì„¤ë„ ì¢‹ì€ ì„ íƒì´ë‹¤."
    ),
    "ğŸ˜ ë¬´ê¸°ë ¥/ì§€ì¹¨": (
        "ì§€ì¹œ ë§ˆìŒì„ ë‹¤ê·¸ì¹˜ì§€ ì•Šê³ , ì²œì²œíˆ ì¼ì–´ë‚˜ë„ë¡ ë„ì™€ì£¼ëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ì‘ê³  ì‚¬ì†Œí•œ ê²ƒë“¤ì˜ ê¸°ì¨ì„ ë– ì˜¬ë¦¬ê²Œ í•˜ëŠ” ì—ì„¸ì´, ì”ì”í•˜ê³  ë”°ëœ»í•œ ì„±ì¥ ì†Œì„¤, "
        "â€˜ì§€ê¸ˆì€ ì‰¬ì–´ë„ ê´œì°®ë‹¤â€™ê³  ë§í•´ ì£¼ëŠ” ì±…ì„ ìš°ì„ ì ìœ¼ë¡œ ê³¨ë¼ë¼."
    ),
    "ğŸ˜¡ í™”ë‚¨/ì§œì¦": (
        "ë¶„ë…¸ë¥¼ ë” í‚¤ìš°ê¸°ë³´ë‹¤ëŠ”, ê·¸ ê°ì •ì„ ì´í•´í•˜ê³  ì•ˆì „í•˜ê²Œ í’€ì–´ë‚¼ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ìœ ë¨¸ì™€ í’ìê°€ ì„ì¸ ì†Œì„¤, ê°ì •ì„ ê°ê´€ì ìœ¼ë¡œ ë°”ë¼ë³´ê²Œ ë„ì™€ì£¼ëŠ” ì‹¬ë¦¬/ì—ì„¸ì´, "
        "í˜¹ì€ ì™„ì „íˆ ë‹¤ë¥¸ ì„¸ê³„ì— ëª°ì…í•´ì„œ ì ì‹œ ë¶„ë…¸ë¥¼ ìŠê²Œ í•´ ì£¼ëŠ” ì±…ì„ ê³¨ë¼ë¼."
    ),
    "ğŸ˜¤ ìŠ¤íŠ¸ë ˆìŠ¤/ì••ë°•": (
        "ì••ë°•ê°ê³¼ ë¶€ë‹´ì„ ëœì–´ ì£¼ê³ , ìˆ¨ì„ ëŒë¦´ ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ì™„ë²½ì£¼ì˜ë¥¼ ë‚´ë ¤ë†“ê²Œ í•˜ëŠ” ìê¸°ê³„ë°œì„œ, í˜„ì‹¤ì ì¸ ìœ„ë¡œë¥¼ ê±´ë„¤ëŠ” ì—ì„¸ì´, "
        "ì Šì€ ì„¸ëŒ€ì˜ ê³ ë¯¼ì„ ê³µê°í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ê³¨ë¼ë¼."
    ),
    "ğŸ˜” ì™¸ë¡œì›€": (
        "â€˜ë‚˜ë§Œ ì™¸ë¡œìš´ ê²Œ ì•„ë‹ˆêµ¬ë‚˜â€™ë¼ëŠ” ê°ê°ì„ ì£¼ëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ê´€ê³„ì™€ ì™¸ë¡œì›€ì„ ë‹¤ë£¨ëŠ” ì—ì„¸ì´, ì‚¬ëŒë“¤ ì‚¬ì´ì˜ ì˜¨ê¸°ë¥¼ ë³´ì—¬ì£¼ëŠ” ì†Œì„¤, "
        "ê³ ë…ì„ ë‚˜ì˜ê²Œë§Œ ë³´ì§€ ì•ŠëŠ” ì‹œì„ ì˜ ì±…ì„ ê³¨ë¼ë¼."
    ),
    "ğŸ¤” ìš°ìš¸ê°": (
        "ë„ˆë¬´ ìê·¹ì ì´ê±°ë‚˜ ëƒ‰ì†Œì ì¸ ì±…ì€ í”¼í•˜ê³ , "
        "ìš°ìš¸í•œ ë§ˆìŒì„ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë‹¤ë£¨ë©´ì„œë„ ì‘ì€ í¬ë§ì˜ ë¶ˆì”¨ë¥¼ ë‚¨ê²¨ ì£¼ëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ìê¸°í˜ì˜¤ë¥¼ ì¤„ì—¬ ì£¼ëŠ” ì‹¬ë¦¬/ì—ì„¸ì´, ì„œì„œíˆ ì¹˜ìœ ë˜ëŠ” ì—¬ì •ì„ ê·¸ë¦¬ëŠ” ì†Œì„¤ì„ ê³¨ë¼ë¼."
    ),
    "ğŸ˜Œ í‰ì˜¨/ë‚˜ë¦„ ê´œì°®ìŒ": (
        "ì§€ê¸ˆì˜ í‰ì˜¨í•¨ì„ ê¹Šê²Œ ì¦ê¸°ê±°ë‚˜, ì°¨ë¶„íˆ ë‚˜ë¥¼ ëŒì•„ë³¼ ìˆ˜ ìˆëŠ” ì±…ì´ ì¢‹ë‹¤. "
        "ì‚¬ìƒ‰ì ì¸ ì—ì„¸ì´, ì”ì”í•œ ë¬¸ì¥ì´ ì•„ë¦„ë‹¤ìš´ ì†Œì„¤, "
        "ìƒˆë¡œìš´ ê´€ì ì„ ì—´ì–´ ì£¼ëŠ” ì¸ë¬¸/ì‹¬ë¦¬ ì„œì  ë“±ì„ ìš°ì„ ì ìœ¼ë¡œ ê³¨ë¼ë¼."
    ),
}

GENRE_OPTIONS = ["ì†Œì„¤", "ì—ì„¸ì´", "ìê¸°ê³„ë°œ", "ì‹¬ë¦¬í•™", "ì‹œ/ì‚°ë¬¸", "ê¸°íƒ€"]
LENGTH_LABELS = ["ìƒê´€ì—†ìŒ", "ì§§ê²Œ", "ì¤‘ê°„", "ê¸¸ê²Œ"]
ORIGIN_OPTIONS = ["ìƒê´€ì—†ìŒ", "í•œêµ­ ì‘ê°€ ìœ„ì£¼", "í•´ì™¸ ì‘ê°€ ìœ„ì£¼"]


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. í”„ë¡¬í”„íŠ¸ ìƒì„± & JSON íŒŒì‹± (ê°ì • ê°•ì¡° ë²„ì „)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_recommend_prompt(
    emotion_main: str,
    emotion_detail: str,
    genre: str,
    length_pref: str,
    origin_pref: str,
) -> str:
    # ì†Œì„¤ì´ ì•„ë‹ ë• ë¶„ëŸ‰ ë¬´ì˜ë¯¸
    length_text = length_pref if genre == "ì†Œì„¤" else "ìƒê´€ì—†ìŒ"

    # ì´ëª¨í‹°ì½˜ ì œê±°í•œ ê°ì • í…ìŠ¤íŠ¸ (ì˜ˆ: "ğŸ˜Š ê¸°ì¨/ì„¤ë ˜" -> "ê¸°ì¨/ì„¤ë ˜")
    if " " in emotion_main:
        emotion_text = emotion_main.split(" ", 1)[1]
    else:
        emotion_text = emotion_main

    # ê°ì •ë³„ ì±… ìŠ¤íƒ€ì¼ ì„¤ëª…
    style_guide = EMOTION_STYLE.get(
        emotion_main,
        "ì‚¬ìš©ìì˜ í˜„ì¬ ê°ì •ì— ì˜ ë§ëŠ” ë¶„ìœ„ê¸°ì˜ ì±…ì„ ê³¨ë¼ë¼.",
    )

    prompt = """
ë„ˆëŠ” í•œêµ­ ë…ìë¥¼ ìœ„í•œ ì±… ì¶”ì²œ ì „ë¬¸ê°€ì•¼.

[ì‚¬ìš©ì ê°ì • ì •ë³´]
- ê°ì •(ëŒ€ë¶„ë¥˜): {emotion_main} (í…ìŠ¤íŠ¸: {emotion_text})
- ê°ì •(êµ¬ì²´): {emotion_detail}

[ì‚¬ìš©ì ì·¨í–¥ ì •ë³´]
- ì„ í˜¸ ì¥ë¥´: {genre}
- ì†Œì„¤ ë¶„ëŸ‰ ì„ í˜¸: {length_text}
- ì‘ê°€ ì„ í˜¸: {origin_pref}

[ê°ì •ì— ë”°ë¥¸ ì±… ì„ íƒ ê°€ì´ë“œ]
{style_guide}

ìœ„ ê°€ì´ë“œë¥¼ ë°˜ë“œì‹œ ë°˜ì˜í•´ì„œ, ê°ì •ì´ ë°”ë€Œë©´ ì¶”ì²œë˜ëŠ” ì±…ì˜ ë¶„ìœ„ê¸°ë„ ë¶„ëª…íˆ ë‹¬ë¼ì§€ë„ë¡ í•´ë¼.
íŠ¹íˆ 'ê¸°ì¨/ì„¤ë ˜'ê³¼ 'ìŠ¬í””/ìš°ìš¸ê°/í™”ë‚¨/ìŠ¤íŠ¸ë ˆìŠ¤'ì²˜ëŸ¼ ì •ë°˜ëŒ€ì— ê°€ê¹Œìš´ ê°ì •ì¼ ë•ŒëŠ”
ê°€ëŠ¥í•˜ë©´ ì„œë¡œ ë‹¤ë¥¸ ê³„ì—´ì˜ ì±…ì„ ê³ ë¥´ë ¤ê³  ë…¸ë ¥í•´ë¼.

[ì¶”ì²œ ì¡°ê±´]
- ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” í•œêµ­ì–´ ì±…(ì›ì„œ/ë²ˆì—­ í¬í•¨) 2ê¶Œì„ ì¶”ì²œí•´ì¤˜.
- ë„ˆë¬´ ì˜¤ë˜ëœ ê³ ì „ë§Œ ì¶”ì²œí•˜ì§€ ë§ê³ , ìµœê·¼ê¹Œì§€ë„ ë§ì´ ì½íˆëŠ” ì±…ì„ ì„ì–´ì¤˜.
- ê°™ì€ ì‹œë¦¬ì¦ˆë‚˜ ê°™ì€ ì œëª©ì€ í”¼í•˜ê³ , ëŠë‚Œì´ ì¡°ê¸ˆ ë‹¤ë¥¸ ë‘ ê¶Œìœ¼ë¡œ ê³¨ë¼ì¤˜.
- í•œêµ­ ë…ìê°€ ì¼ë°˜ ì„œì ì—ì„œ êµ¬í•  ìˆ˜ ìˆì„ ë²•í•œ ì±… ìœ„ì£¼ë¡œ ê³¨ë¼ì¤˜.

[ìš”ì•½ ê´€ë ¨ ìš”êµ¬]
- summary í•­ëª©ì—ëŠ” ì±…ì˜ ì£¼ìš” ë‚´ìš©ì„ **4~5ë¬¸ì¥**ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í•œêµ­ì–´ë¡œ ìš”ì•½í•´ì¤˜.
- reason í•­ëª©ì—ëŠ” ì§€ê¸ˆ ê°ì •/ìƒí™©ê³¼ ì™œ ì˜ ë§ëŠ”ì§€ **1~2ë¬¸ì¥**ìœ¼ë¡œ ì„¤ëª…í•´ì¤˜.
  ì´ë•Œ ë°˜ë“œì‹œ í˜„ì¬ ê°ì •({emotion_text})ê³¼ ì—°ê²°í•´ì„œ ì„¤ëª…í•´ë¼.
  (ì˜ˆ: "ì§€ê¸ˆì²˜ëŸ¼ ~í•œ ê°ì •ì¼ ë•Œ", "ìŠ¬í””ì´ ê¹Šì–´ì§€ëŠ” í•˜ë£¨ì—", "ê¸°ë¶„ ì¢‹ì€ ì„¤ë ˜ì„ ì˜¤ë˜ ìœ ì§€í•˜ê³  ì‹¶ì„ ë•Œ" ë“±)

[ì¶œë ¥ í˜•ì‹ (JSONë§Œ ë°˜í™˜)]
ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ì˜ JSON ë°°ì—´ë§Œ ì¶œë ¥í•˜ê³ ,
JSON ì•ë’¤ì—ëŠ” ì–´ë–¤ ì„¤ëª… ë¬¸ì¥ë„ ì“°ì§€ ë§ˆ.

[
  {{
    "title": "ì±… ì œëª©",
    "author": "ì €ì ì´ë¦„",
    "publisher": "ì¶œíŒì‚¬ ì´ë¦„",
    "summary": "ì±…ì˜ ì£¼ìš” ë‚´ìš©ì„ 4~5ë¬¸ì¥ ì •ë„ë¡œ í•œêµ­ì–´ë¡œ ìš”ì•½",
    "reason": "ì§€ê¸ˆ ê°ì •ê³¼ ì¥ë¥´, ìƒí™©ì— ì™œ ì–´ìš¸ë¦¬ëŠ”ì§€ 1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…"
  }},
  {{
    "title": "ë‘ ë²ˆì§¸ ì±… ì œëª©",
    "author": "ì €ì ì´ë¦„",
    "publisher": "ì¶œíŒì‚¬ ì´ë¦„",
    "summary": "ì±…ì˜ ì£¼ìš” ë‚´ìš©ì„ 4~5ë¬¸ì¥ ì •ë„ë¡œ í•œêµ­ì–´ë¡œ ìš”ì•½",
    "reason": "ì§€ê¸ˆ ê°ì •ê³¼ ì¥ë¥´, ìƒí™©ì— ì™œ ì–´ìš¸ë¦¬ëŠ”ì§€ 1~2ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…"
  }}
]
""".format(
        emotion_main=emotion_main,
        emotion_text=emotion_text,
        emotion_detail=emotion_detail,
        genre=genre,
        length_text=length_text,
        origin_pref=origin_pref,
        style_guide=style_guide,
    )
    return prompt


def extract_json(text: str) -> str:
    # ``` ``` ì½”ë“œë¸”ë¡ ì•ˆì— ìˆì„ ê°€ëŠ¥ì„± ì²˜ë¦¬
    if "```" in text:
        parts = text.split("```")
        text = max(parts, key=len).strip()

    start = text.find("[")
    end = text.rfind("]")
    if start != -1 and end != -1 and end > start:
        return text[start : end + 1].strip()
    return text.strip()


def parse_books(json_text: str):
    cleaned = extract_json(json_text)
    try:
        data = json.loads(cleaned)
        if isinstance(data, dict):
            return [data]
        if isinstance(data, list):
            return data
        return []
    except Exception:
        return []


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. Streamlit UI
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(
    page_title="ê°ì •ìœ¼ë¡œ ê³ ë¥´ëŠ” ì±… í•œ ê¶Œ",
    page_icon="ğŸ“š",
    layout="centered",
)

st.title("ğŸ“š ê°ì •ìœ¼ë¡œ ê³ ë¥´ëŠ” ì±… í•œ ê¶Œ")
st.caption("ì§€ê¸ˆ ë‚´ ë§ˆìŒì— ë”± ë§ëŠ” ë¶„ìœ„ê¸°ì˜ ì±…ì„ AIê°€ ê³¨ë¼ì£¼ëŠ” ì‘ì€ ì„œê°€")


# 1) ê°ì • ì„ íƒ
st.subheader("1. ì§€ê¸ˆ ë§ˆìŒ ìƒíƒœëŠ” ì–´ë•Œìš”?")

emotion_main = st.selectbox(
    "ì§€ê¸ˆ ëŠê»´ì§€ëŠ” ê°ì •ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒì„ ê³¨ë¼ ì£¼ì„¸ìš”.",
    EMOTION_MAIN,
)

detail_options = EMOTION_DETAIL_MAP.get(emotion_main, ["ì˜ ëª¨ë¥´ê² ì–´ìš”"])
emotion_detail = st.selectbox(
    "ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§í•˜ë©´ ì–´ë–¤ ëŠë‚Œì¸ê°€ìš”?",
    detail_options,
)


# 2) ì¥ë¥´ & ë¶„ëŸ‰
st.subheader("2. ì–´ë–¤ ì±…ì´ ëŒë¦¬ë‚˜ìš”?")

genre = st.selectbox("ì¥ë¥´ë¥¼ ê³¨ë¼ ì£¼ì„¸ìš”.", GENRE_OPTIONS)

length_pref = "ìƒê´€ì—†ìŒ"
if genre == "ì†Œì„¤":
    length_pref = st.selectbox("ì†Œì„¤ ë¶„ëŸ‰ì€ ì–´ëŠ ì •ë„ê°€ ì¢‹ì•„ìš”?", LENGTH_LABELS)

origin_pref = st.selectbox(
    "êµ­ë‚´/í•´ì™¸ ì‘ê°€ ì„ í˜¸ê°€ ìˆë‚˜ìš”?",
    ORIGIN_OPTIONS,
)

make_image = st.checkbox("ì¶”ì²œ ì±…ì˜ í‘œì§€ ì´ë¯¸ì§€ë¥¼ ë³´ê³  ì‹¶ì–´ìš”", value=True)


# 3) ì¶”ì²œ ì‹¤í–‰
if st.button("ğŸ“– ê°ì •ì— ë§ëŠ” ì±… ì¶”ì²œ ë°›ê¸°"):
    st.write("---")

    prompt = build_recommend_prompt(
        emotion_main=emotion_main,
        emotion_detail=emotion_detail,
        genre=genre,
        length_pref=length_pref,
        origin_pref=origin_pref,
    )

    try:
        with st.spinner("ë‹¹ì‹ ì˜ ê°ì •ì— ì–´ìš¸ë¦¬ëŠ” ì±…ì„ ê³ ë¥´ëŠ” ì¤‘ì´ì—ìš”...â˜•"):
            raw_text = ai_generate(prompt)
            books = parse_books(raw_text)
    except Exception as e:
        st.error("AIì—ê²Œ ì±… ì¶”ì²œì„ ìš”ì²­í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.")
        st.text(str(e))
        books = []

    if not books:
        st.warning("ì¶”ì²œ ê²°ê³¼ë¥¼ ì œëŒ€ë¡œ ë°›ì•„ì˜¤ì§€ ëª»í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ë³´ê±°ë‚˜ ì¡°ê±´ì„ ì¡°ê¸ˆ ë°”ê¿”ë³´ì„¸ìš”.")
    else:
        random.shuffle(books)
        books = books[:2]

        st.markdown("- ê°ì •: **{} Â· {}**".format(emotion_main, emotion_detail))
        st.markdown("- ì¥ë¥´: **{}**".format(genre))
        if genre == "ì†Œì„¤":
            st.markdown("- ë¶„ëŸ‰: **{}**".format(length_pref))
        st.markdown("- ì‘ê°€ ì„ í˜¸: **{}**".format(origin_pref))
        st.write("")

        if len(books) == 1:
            st.info("ì´ë²ˆì—ëŠ” ë”± í•œ ê¶Œë§Œ ìì‹  ìˆê²Œ ì¶”ì²œí•´ ì¤„ ìˆ˜ ìˆì—ˆì–´ìš” ğŸ™‚")

        for i, book in enumerate(books, start=1):
            title = book.get("title", "ì œëª© ì •ë³´ ì—†ìŒ")
            author = book.get("author", "ì €ì ì •ë³´ ì—†ìŒ")
            publisher = book.get("publisher", "ì¶œíŒì‚¬ ì •ë³´ ì—†ìŒ")
            summary = book.get("summary", "ìš”ì•½ ì •ë³´ ì—†ìŒ")
            reason = book.get("reason", "")

            st.markdown("### {}. **{}**".format(i, title))

            meta = get_book_metadata(title, author)
            cover_url = meta.get("cover_url")
            avg_rating = meta.get("average_rating")
            ratings_count = meta.get("ratings_count")

            kyobo_url = build_kyobo_url(title)

            if make_image:
                cols = st.columns([1, 2])
            else:
                cols = [st.container(), st.container()]

            # ì™¼ìª½: í‘œì§€
            if make_image:
                with cols[0]:
                    if cover_url:
                        st.image(cover_url, use_column_width=True)
                    else:
                        st.caption("í‘œì§€ ì´ë¯¸ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆì–´ìš” ğŸ¥²")

            # ì˜¤ë¥¸ìª½: ì •ë³´
            with (cols[1] if make_image else cols[0]):
                st.markdown("- ì €ì: **{}**".format(author))
                st.markdown("- ì¶œíŒì‚¬: **{}**".format(publisher))

                if avg_rating is not None:
                    if ratings_count:
                        st.markdown(
                            "â­ í‰ì : **{:.1f} / 5.0** ({}ëª… í‰ê°€)".format(
                                avg_rating, ratings_count
                            )
                        )
                    else:
                        st.markdown("â­ í‰ì : **{:.1f} / 5.0**".format(avg_rating))

                st.markdown(
                    "[ğŸ”— êµë³´ë¬¸ê³ ì—ì„œ '{}' ê²€ìƒ‰í•˜ê¸°]({})".format(title, kyobo_url)
                )

                st.markdown("**ğŸ“– ë‚´ìš© ìš”ì•½ (AI, 4~5ë¬¸ì¥)**")
                st.write(summary)

                if reason:
                    st.markdown("**ğŸ’¡ ì¶”ì²œ ì´ìœ  (AI)**")
                    st.write(reason)

            st.write("---")
